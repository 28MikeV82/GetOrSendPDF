# Техническое задание

Необходимо реализовать методы:
- `/tl-vinwin-backend/vinwin/getPDF` - получить pdf отчета
- `/tl-vinwin-backend/vinwin/sendPDF` - отправить созданный pdf на e-mail


## Метод sendPDF
`/tl-vinwin-backend/vinwin/sendPDF`

### Входные параметры
- **token** - токен ключ сервиса, обязательный
- **email** - адрес электронной почты, обязательный
- **sts** - СТС автомобиля, обязательный
- **vin** - ВИН-код автомобиля, необязательный, если определен параметр **grz**
- **grz** - государственный регистрационный знак, необязательный, если определен параметр **vin**

Пример:
<pre>{
    "token": "adbf781378af11e5b89a000c293f7799",
    "email": "my_email@mail.ru",
    "sts": "7717206429",
    "vin": "XWEHN512BD0001573"
}
</pre>


### Проверка входных параметров
При отсутствии обязательных входных параметров или неправильных их значениях, необходимо выводить соответствующую ошибку (см. Коды завершения операций).

Для проверки значений необходимо использовать следующие регулярные выражения:
- **email**

`^[-\w.]+@([A-z0-9][-A-z0-9]+\.)+[A-z]{2,4}$`

- **sts**

`^\d{2}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{2}\d{6}$|^\d{10}$`

- **grz**

`^([авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{1}\d{3}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{2}\d{2,3})$|^([авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{2}\d{6})$|^(\d{4}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{2}\d{2})$|^(\d{3}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXYdD]{2}\d{3})$|^(\d{3}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXYdD]{1}\d{5})$|^([авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{2}\d{3}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{1}\d{2})$|^([авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{2}\d{6})$|^([тТtT]{1}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{2}\d{5})$|^(\d{3}[авекмнорстхуabekmhopctxyАВЕКМНОРСТХУABEKMHOPCTXY]{1}\d{2})$`

- **vin**

`^[wertyupasdfghjklzxcvbnmWERTYUPASDFGHJKLZXCVBNM0-9]{17}$`

Регулярные выражение конфигурируются в config.properties, который расположен внутри tl-vinwin-backend.war.


### Логика работы
Сгенерированные pdf отчеты необходимо кешировать на сервер-сайд. Критериями для поиска кешированных файлов должны являться **vin**, **sts**, **grz** и дата формирования. В первую очередь происходит поиск отчета по входным параметрам в кеше сервер-сайда. Если отчет не найден, происходит его генерация, для этого с помощью msp-sgw-ws сервисов запрашиваются необходимые данные, происходит генерация pdf по шаблону, кеширование отчета на сервер-сайд и отправка отчета на e-mail пользователю.


#### Получение авто-истории

- url сервиса: `http://hub.msp-tl.ru/msp-sgw-ws/service/api/storage/getData`
- HTTP-метод: `POST`
- Content-Type: `application/json`
- json-запрос: 
<pre>
{
    "dataSet": "avtokod-history",
    "token" : "взять из входных параметров",
    "terms": [
        {
            "name": "sts",
            "value": "взять из входных параметров"
        },
        {
            "name": "vin",
            "value": "взять из входных параметров"
        },
        {
            "name": "grz",
            "value": "взять из входных параметров"
        }
    ]
}
</pre>

Если авто-история не найдена (пришел соответствующий код и сообщение ошибки) возвращается ошибка - данные не найдены (см. Коды завершения операций).

#### Получение штрафов пользователя
- url сервиса: `http://hub.msp-tl.ru/msp-sgw-ws/service/api/storage/getData`
- HTTP-метод: `POST`
- Content-Type: `application/json`
- json-запрос:
<pre>
{
    "token": "взять из входных параметров",
    "dataSet": "offence-avtokod-sts",
    "terms": [ 
        {
            "name": "sts",
            "value": "взять из входных параметров"
        }
    ]    
}
</pre>

Если информация по штрафам не найдена, ошибки не происходит, соответствующий раздел pdf оставляется не заполненным.

Если внешняя информационная система ответила любой другой ошибкой, то выводится ошибка Internal Server Error (см. Коды завершения операций). 

#### Генерация pdf отчета
Для генерации pdf используется [JasperReports](https://ru.wikipedia.org/wiki/JasperReports "JasperReports on ru.wiki"), готовый jrxml-шаблон предоставлен (autohistory.jrxml). Шаблон отчета компилируется "на лету", генерация использует только откомпилированный шаблон. Шаблон отчета вынесен из war, чтобы его можно было поменять без компиляции war. Для этого удаляется компилированный шаблон и заменяется autohistory.jrxml.
Пути к шаблону и директории для сгенерированных отчетов задаются в config.properties, который расположен внутри tl-vinwin-backend.war. 

#### Кэширование отчета на сервер-сайд
*TBD*

#### Отправка отчета на e-mail пользователю 
Для отправки используется готовый сервис:
- url сервиса: `http://hub.msp-tl.ru/msp-sgw-ws/service/api/email/send`
- HTTP-метод: `POST`
- Content-Type: `application/json`
- json-запрос:
<pre>
{
    "token": "взять из входных параметров",
    "to_email": "взять <b>email</b> из входных параметров",
    "subject": "Тема письма (см. ниже)",
    "body": "Тело письма (см. ниже)",
    "attachments" : [
        {
            "content_encoded": "base_64", 
            "content_type": "text/plain;charset=utf-8",
            "filename": "Название файла (см.ниже)",
            "content": "PD94bWwgdmVyc2lvbj1cIjEuMFwiPz48YT7QoNC+0LHQuNC9INCT0YPQtDwvYT4="
        }
  ]
}
</pre>

- Тема письма: <blockquote> Полная информация об автомобиле %**grz**% </blockquote>
(предусмотреть смену темы при необходимости).

- Тело письма: <blockquote>Вы запросили информацию об истории владения и эксплуатации автомобиля через приложение "Автоистория". Во вложении полная информация об автомобиле [grz.mycarstory.ru](grz.mycarstory.ru "Автоистория").</blockquote> (предусмотреть смену тела письма при необходимости)

- Название файла: %**grz%**.pdf (предусмотреть возможность смены названия файла)

**grz** автомобиля (если **grz** не передан, то используется **vin**) подставляется в заголовок и тело письма динамически из входных параметров метода. 
~Тема и тело письма, а также формат названия файла задаются в config.properties, который расположен внутри tl-vinwin-backend.war.config.properties, который расположен внутри tl-vinwin-backend.war.~
*TBD описать какие свойства отвечают за что и как формируется маска для названия файла. Описать как менять тему и тело письма Описать как менять тему и тело письма.*

### Формат ответа
Результатом запроса является объект, сериализованный в формате представления данных JSON (объект JSON), содержащий следующие поля:
- **errorCode** – в случае успешного выполнения содержит «0», в случае возникновения ошибки возвращает числовой код ошибки (смотри коды завершения операций)
- **errorMessage** – содержит текстовое поле с кратким описанием ошибки
- **result** – содержащий результат выполнения запроса в формате boolean (true/false)

Все поля ответа обязательны


## Метод getPDF
`/tl-vinwin-backend/vinwin/getPDF`

### Входные параметры
- **token** - токен ключ сервиса, обязательный
- **sts** - СТС автомобиля, обязательный
- **vin** - ВИН-код автомобиля, необязательный, если определен параметр **grz**
- **grz** - государственный регистрационный знак, необязательный, если определен параметр **vin**

Пример:
<pre>{
    "token": "adbf781378af11e5b89a000c293f7799",
    "sts": "7717206429",
    "vin": "XWEHN512BD0001573"
}
</pre>


### Проверка входных параметров
Проверка соответствует проверке входных параметров метода **sendPDF**, отличие только в отсутствии параметра **email**.


### Логика работы метода
Логика соответствует логике метода **sendPDF**, но вместо отправки отчета на почту пользователя, отчет возвращается как вложенный файл (`Content-Disposition='attachment; filename=а665ус197.pdf'`).


## Коды завершения операций
(errorCode errorMessage - Описание):
* 0 OK - Запрос выполнен успешно
* 400 Bad Request - Некорректное тело запроса
* 405 Missing fields - Не переданы обязательные параметры или заголовки
* 406 Not valid - Невалидный параметр
* 500 Internal Server Error - Во всех остальных случаях
* 504 Missing data - Данные не найдены


# Реализация
Текущий статус:
- метод **getPDF** - **реализовано**
- метод **sendPDF** - **реализовано**
- кеширование отчетов - **реализовано** хранением файлов на диске, но потребуется оптимизация, чтобы не тормозить при очень больших объемах (если такое ожидается) отчетов в кэше.
- открытые задачи: переделать шрифт и JasperReport шаблон
